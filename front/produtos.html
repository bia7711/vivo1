<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Negociar Troca</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-gray-100 min-h-screen py-8">
  <div class="container mx-auto px-4 max-w-4xl">
    <!-- Header com botão voltar -->
    <div class="mb-6">
      <button onclick="window.history.back()" class="bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>Voltar
      </button>
    </div>

    <!-- Card da peça da loja -->
    <div class="bg-white shadow-lg rounded-2xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Peça que você deseja</h2>
      
      <div class="flex flex-col md:flex-row gap-6">
        <img id="pecaImagem" src="" alt="" class="w-full md:w-48 h-48 object-cover rounded-lg">
        
        <div class="flex-1">
          <h3 id="titulo" class="text-xl font-bold text-gray-800 mb-2"></h3>
          <p id="descricao" class="text-gray-600 mb-4"></p>
          
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-gray-50 p-3 rounded-xl shadow-sm">
              <span class="text-sm text-gray-500">Categoria</span>
              <p id="categoria" class="font-semibold text-gray-800"></p>
            </div>
            <div class="bg-gray-50 p-3 rounded-xl shadow-sm">
              <span class="text-sm text-gray-500">Tipo</span>
              <p id="tipo" class="font-semibold text-gray-800"></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção de seleção da peça para troca -->
    <div id="selecaoTroca" class="bg-white shadow-lg rounded-2xl p-6 hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Selecione sua peça para troca</h2>
      
      <div class="mb-4">
        <label for="pecaUsuario" class="block text-sm font-medium text-gray-700 mb-2">
          Suas peças disponíveis para troca:
        </label>
        <select id="pecaUsuario" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
          <option value="">Selecione uma peça</option>
        </select>
      </div>

      <button id="btnConfirmarTroca" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-xl shadow-md transition">
        Confirmar Proposta de Troca
      </button>
    </div>

    <!-- Modal de erro quando não tem peças -->
    <div id="modalSemPecas" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Atenção</h3>
        <p class="text-gray-600 mb-6">Você precisa cadastrar pelo menos uma peça antes de poder negociar.</p>
        <div class="flex justify-end">
          <button onclick="redirecionarParaPerfil()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">
            Cadastrar Peça
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de sucesso -->
    <div id="modalSucesso" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <div class="text-center">
          <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Sucesso!</h3>
          <p class="text-gray-600 mb-4">Requisição de troca enviada com sucesso.</p>
          <button onclick="redirecionarParaLoja()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">
            Voltar para Loja
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let pecaDestinoId = null;
    let pecaDestinoData = null;

    // Função para obter parâmetros da URL
    function getUrlParams() {
      const params = {};
      const queryString = window.location.search.substring(1);
      const pairs = queryString.split('&');
      
      for (let i = 0; i < pairs.length; i++) {
        const pair = pairs[i].split('=');
        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
      }
      return params;
    }

    // Funções de redirecionamento
    function redirecionarParaPerfil() {
      window.location.href = 'perfil.html';
    }

    function redirecionarParaLoja() {
      window.location.href = 'loja.html';
    }

    // Carregar dados do produto e verificar peças do usuário
    const loadProductData = async () => {
      const params = getUrlParams();
      const productId = params.id;

      if (!productId) {
        alert('ID do produto não encontrado na URL');
        return;
      }

      try {
        // Buscar dados do produto
        const response = await fetch(`/pecas?id=${productId}`);
        if (!response.ok) {
          throw new Error('Produto não encontrado');
        }
        
        pecaDestinoData = await response.json();
        pecaDestinoId = productId;

        // Preencher informações da peça
        document.getElementById('titulo').innerText = pecaDestinoData.titulo;
        document.getElementById('descricao').innerText = pecaDestinoData.descricao;
        document.getElementById('categoria').innerText = pecaDestinoData.categoria;
        document.getElementById('tipo').innerText = pecaDestinoData.tipo;
        
        if (pecaDestinoData.imagem) {
          document.getElementById('pecaImagem').src = pecaDestinoData.imagem;
        }

        // Verificar se usuário tem peças para troca
        await verificarPecasUsuario();

      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        alert('Erro ao carregar informações. Tente novamente.');
      }
    };

    // Verificar se usuário tem peças cadastradas
    const verificarPecasUsuario = async () => {
      try {
        const response = await fetch('/pecas-usuario');
        if (!response.ok) {
          throw new Error('Erro ao carregar peças do usuário');
        }

        const userPecas = await response.json();
        
        if (userPecas.length === 0) {
          // Usuário não tem peças - mostrar modal
          document.getElementById('modalSemPecas').classList.remove('hidden');
        } else {
          // Usuário tem peças - mostrar seção de seleção
          document.getElementById('selecaoTroca').classList.remove('hidden');
          popularSelectPecas(userPecas);
        }

      } catch (error) {
        console.error('Erro ao verificar peças:', error);
        alert('Erro ao carregar suas peças. Tente novamente.');
      }
    };

    // Popular select com peças do usuário
    const popularSelectPecas = (pecas) => {
      const select = document.getElementById('pecaUsuario');
      select.innerHTML = '<option value="">Selecione uma peça</option>';
      
      pecas.forEach(peca => {
        const option = document.createElement('option');
        option.value = peca.id;
        option.textContent = peca.titulo;
        select.appendChild(option);
      });
    };

    // Enviar proposta de troca
    const enviarPropostaTroca = async () => {
      const pecaOrigemId = document.getElementById('pecaUsuario').value;
      
      if (!pecaOrigemId) {
        alert('Por favor, selecione uma peça para trocar.');
        return;
      }

      try {
        const response = await fetch('/troca', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            idPecaOrigem: pecaOrigemId,
            idPecaDestino: pecaDestinoId
          }),
        });

        if (response.ok) {
          document.getElementById('modalSucesso').classList.remove('hidden');
        } else {
          const errorText = await response.text();
          alert('Erro ao enviar proposta: ' + errorText);
        }
      } catch (error) {
        console.error('Erro ao enviar proposta:', error);
        alert('Erro ao enviar proposta de troca. Tente novamente.');
      }
    };

    // Event listeners
    document.addEventListener('DOMContentLoaded', loadProductData);
    document.getElementById('btnConfirmarTroca').addEventListener('click', enviarPropostaTroca);
  </script>
</body>
</html>
